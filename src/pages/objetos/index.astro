---
import Base from '@/layouts/Base.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

// Interfaz para los datos procesados
interface OAWithScreens {
  slug: string;
  title: string;
  cover: string;
  level: string;
  duration?: string;
  summary?: string;
  screens: Array<{ slug: string; title: string }>;
}

// Obtener todas las entradas de objetos
const allObjetos = await getCollection('objetos');

// Separar los OAs principales de las pantallas
const oasPrincipales = allObjetos.filter((obj: CollectionEntry<'objetos'>) => !obj.id.includes('/'));
const pantallas = allObjetos.filter((obj: CollectionEntry<'objetos'>) => obj.id.includes('/'));

// Construir la estructura de datos con OAs y sus pantallas
const oaData: OAWithScreens[] = oasPrincipales
  .sort((a: CollectionEntry<'objetos'>, b: CollectionEntry<'objetos'>) => a.data.order - b.data.order)
  .map((oa: CollectionEntry<'objetos'>) => {
    const slug = oa.id.replace('.mdx', '');
    
    // Obtener todas las pantallas de este OA
    const screens = pantallas
      .filter((p: CollectionEntry<'objetos'>) => p.data.oaSlug === slug)
      .sort((a: CollectionEntry<'objetos'>, b: CollectionEntry<'objetos'>) => a.data.order - b.data.order)
      .map((p: CollectionEntry<'objetos'>) => ({
        slug: p.data.screenSlug!,
        title: p.data.title
      }));
    
    return {
      slug,
      title: oa.data.title,
      cover: oa.data.cover,
      level: oa.data.level,
      duration: oa.data.duration,
      summary: oa.data.summary,
      screens
    };
  });

const breadcrumbItems = [
  { label: 'Inicio', href: '/' },
  { label: 'Objetos de aprendizaje' }
];
---
<Base title="Objetos de aprendizaje · Química 3">
  <main id="contenido" class="mx-auto max-w-screen-xl px-4 py-10">
    <Breadcrumb items={breadcrumbItems} />
    
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-cch-azul mb-2">Objetos de aprendizaje</h1>
      <p class="text-slate-600">Explora los temas de Química 3 a través de pantallas interactivas</p>
    </header>
    
    <div class="space-y-8">
      {oaData.map((oa: OAWithScreens) => (
        <article class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-shadow overflow-hidden">
          <div class="grid md:grid-cols-[300px_1fr] gap-6">
            {/* Imagen de portada */}
            <div class="relative md:h-full">
              <img 
                src={oa.cover} 
                alt={oa.title}
                class="w-full h-48 md:h-full object-cover"
                loading="lazy"
              />
              <div class="absolute top-3 left-3 bg-cch-azul text-white px-3 py-1 rounded-full text-xs font-semibold">
                {oa.screens.length} pantallas
              </div>
            </div>

            {/* Contenido */}
            <div class="p-6 md:py-6 md:pr-6 md:pl-0">
              <div class="mb-4">
                <h2 class="text-2xl font-bold text-slate-900 mb-2">
                  {oa.title}
                </h2>
                <div class="flex items-center gap-3 text-sm text-slate-600 mb-3">
                  <span class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                    </svg>
                    {oa.duration}
                  </span>
                  <span>·</span>
                  <span>{oa.level}</span>
                </div>
                <p class="text-slate-600 leading-relaxed">
                  {oa.summary}
                </p>
              </div>

              {/* Lista horizontal de pantallas */}
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wide">
                  Contenido:
                </h3>
                <div class="flex flex-wrap gap-2">
                  {oa.screens.map((screen: { slug: string; title: string }, index: number) => (
                    <a 
                      href={`/objetos/${oa.slug}/${screen.slug}`}
                      class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-cch-azul hover:text-white rounded-lg text-sm font-medium transition-colors group"
                    >
                      <span class="text-xs opacity-70 group-hover:opacity-100">
                        {index + 1}
                      </span>
                      <span>{screen.title}</span>
                    </a>
                  ))}
                </div>
              </div>

              {/* Botón principal */}
              <a 
                href={`/objetos/${oa.slug}/introduccion`}
                class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cch-azul to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg hover:scale-105 transition-all"
              >
                Comenzar objeto de aprendizaje
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </a>
            </div>
          </div>
        </article>
      ))}
    </div>
  </main>
</Base>

<style>
  /* Asegurar que la imagen cubra todo el espacio en desktop */
  @media (min-width: 768px) {
    .md\:h-full {
      min-height: 100%;
    }
  }
</style>
